SELECT *

FROM
(SELECT
  TO_DATE(SCP.CP_EMISSAO, 'YYYYMMDD') AS Data_Emissao,
  TO_DATE(SCP.CP_DATPRF, 'YYYYMMDD') AS Data_Necessidade,
  TO_DATE(MOV.D3_EMISSAO,'YYYYMMDD') AS Data_Movimento,
  (TO_DATE(MOV.D3_EMISSAO,'YYYYMMDD') ) - (TO_DATE(SCP.CP_EMISSAO, 'YYYYMMDD') ) AS LEADTIME,
  CASE
    WHEN (TO_DATE(MOV.D3_EMISSAO,'YYYYMMDD') ) - (TO_DATE(SCP.CP_EMISSAO, 'YYYYMMDD') ) > 3 THEN 'Fora'
    ELSE 'Dentro'
    END AS STATUS_SLA, -- SLA de 3 dias
  CASE 
    WHEN SCP.CP_STATUS = 'E' THEN 'Encerrada'
    ELSE 'Aberta'
    END AS STATUS,
   SCP.CP_NUM ||SCP.CP_ITEM || SCP.CP_FILIAL AS CHAVE,
  CASE 
    WHEN MOV.D3_ESTORNO <> 'S' THEN 'Sem estorno' 
    Else 'Com estorno'
    END AS Estorno,
    MOV.D3_ESTORNO,
    SCP.*
FROM PROTHEUS.SCP010 SCP
LEFT JOIN protheus.SD3010 MOV ON SCP.CP_NUM ||SCP.CP_ITEM || SCP.CP_FILIAL = MOV.D3_NUMSA || MOV.D3_ITEMSA || MOV.D3_FILIAL
WHERE 
  SCP.CP_FILIAL = '010001') CONSULTAALIAS
